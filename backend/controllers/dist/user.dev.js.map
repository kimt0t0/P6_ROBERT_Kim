{"version":3,"sources":["user.js"],"names":["bcrypt","require","User","jwt","emailValidator","passwordValidator","MaskData","passwordSchema","is","min","max","has","uppercase","lowercase","digits","not","symbols","exports","signup","req","res","next","validate","body","email","password","status","json","message","maskedMail","maskEmail2","hash","then","user","save","error","login","findOne","compare","valid","userId","_id","token","sign","expiresIn"],"mappings":";;AAAA;AACA,IAAMA,MAAM,GAAGC,OAAO,CAAC,QAAD,CAAtB;;AACA,IAAMC,IAAI,GAAGD,OAAO,CAAC,gBAAD,CAApB;;AACA,IAAME,GAAG,GAAGF,OAAO,CAAC,cAAD,CAAnB,C,CAAqC;;;AACrC,IAAMG,cAAc,GAAGH,OAAO,CAAC,iBAAD,CAA9B;;AACA,IAAMI,iBAAiB,GAAGJ,OAAO,CAAC,oBAAD,CAAjC;;AACA,IAAMK,QAAQ,GAAGL,OAAO,CAAC,UAAD,CAAxB;;AAEA,IAAMM,cAAc,GAAG,IAAIF,iBAAJ,EAAvB;AAEAE,cAAc,CACTC,EADL,GACUC,GADV,CACc,CADd,EACkB;AADlB,CAEKD,EAFL,GAEUE,GAFV,CAEc,EAFd,EAEkB;AAFlB,CAGKC,GAHL,GAGWC,SAHX,GAGwB;AAHxB,CAIKD,GAJL,GAIWE,SAJX,GAKKF,GALL,GAKWG,MALX,GAMKH,GANL,GAMWI,GANX,GAMiBC,OANjB,G,CAM4B;;AAE5B;;AACA;;AACAC,OAAO,CAACC,MAAR,GAAiB,UAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AACjC,MAAI,CAACjB,cAAc,CAACkB,QAAf,CAAwBH,GAAG,CAACI,IAAJ,CAASC,KAAjC,CAAD,IAA4C,CAACjB,cAAc,CAACe,QAAf,CAAwBH,GAAG,CAACI,IAAJ,CAASE,QAAjC,CAAjD,EAA6F;AACzF,WAAOL,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACC,MAAAA,OAAO,EAAE;AAAV,KAArB,CAAP;AACH,GAFD,MAGK,IAAIxB,cAAc,CAACkB,QAAf,CAAwBH,GAAG,CAACI,IAAJ,CAASC,KAAjC,KAA2CjB,cAAc,CAACe,QAAf,CAAwBH,GAAG,CAACI,IAAJ,CAASE,QAAjC,CAA/C,EAA2F;AAC5F,QAAMI,UAAU,GAAGvB,QAAQ,CAACwB,UAAT,CAAoBX,GAAG,CAACI,IAAJ,CAASC,KAA7B,CAAnB;AACAxB,IAAAA,MAAM,CAAC+B,IAAP,CAAYZ,GAAG,CAACI,IAAJ,CAASE,QAArB,EAA+B,EAA/B,EACCO,IADD,CACO,UAAAD,IAAI,EAAI;AACX,UAAME,IAAI,GAAG,IAAI/B,IAAJ,CAAU;AACnBsB,QAAAA,KAAK,EAAEK,UADY;AAEnBJ,QAAAA,QAAQ,EAAEM;AAFS,OAAV,CAAb;AAIAE,MAAAA,IAAI,CAACC,IAAL,GACCF,IADD,CACM,UAAAD,IAAI;AAAA,eAAIX,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACC,UAAAA,OAAO,EAAE;AAAV,SAArB,CAAJ;AAAA,OADV,WAEO,UAAAO,KAAK;AAAA,eAAIf,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACQ,UAAAA,KAAK,EAALA;AAAD,SAArB,CAAJ;AAAA,OAFZ;AAGH,KATD,WAUO,UAAAA,KAAK;AAAA,aAAIf,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACQ,QAAAA,KAAK,EAALA;AAAD,OAArB,CAAJ;AAAA,KAVZ;AAWH;;AAAA;AACJ,CAlBD;AAoBA;;;AACAlB,OAAO,CAACmB,KAAR,GAAgB,UAACjB,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAChC,MAAMQ,UAAU,GAAGvB,QAAQ,CAACwB,UAAT,CAAoBX,GAAG,CAACI,IAAJ,CAASC,KAA7B,CAAnB;AACAtB,EAAAA,IAAI,CAACmC,OAAL,CAAa;AAACb,IAAAA,KAAK,EAAEK;AAAR,GAAb,EAAkC;AAAlC,GACCG,IADD,CACM,UAAAC,IAAI,EAAI;AACV,QAAG,CAACA,IAAJ,EAAU;AACN,aAAOb,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACQ,QAAAA,KAAK,EAAE;AAAR,OAArB,CAAP;AACH;;AACDnC,IAAAA,MAAM,CAACsC,OAAP,CAAenB,GAAG,CAACI,IAAJ,CAASE,QAAxB,EAAkCQ,IAAI,CAACR,QAAvC,EAAiD;AAAjD,KACCO,IADD,CACO,UAAAO,KAAK,EAAI;AACZ,UAAI,CAACA,KAAL,EAAY;AACR,eAAOnB,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACQ,UAAAA,KAAK,EAAE;AAAR,SAArB,CAAP;AACH;;AACDf,MAAAA,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACjBa,QAAAA,MAAM,EAAEP,IAAI,CAACQ,GADI;AAEjBC,QAAAA,KAAK,EAAEvC,GAAG,CAACwC,IAAJ,CACH;AAACH,UAAAA,MAAM,EAAEP,IAAI,CAACQ;AAAd,SADG,EAEH,qBAFG,EAGH;AAACG,UAAAA,SAAS,EAAE;AAAZ,SAHG;AAFU,OAArB;AAQH,KAbD,WAcO,UAAAT,KAAK;AAAA,aAAIf,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACQ,QAAAA,KAAK,EAALA;AAAD,OAArB,CAAJ;AAAA,KAdZ;AAeH,GApBD,WAqBO,UAAAA,KAAK;AAAA,WAAIf,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACQ,MAAAA,KAAK,EAALA;AAAD,KAArB,CAAJ;AAAA,GArBZ;AAsBH,CAxBD","sourcesContent":["/* VARIABLES */\r\nconst bcrypt = require('bcrypt');\r\nconst User = require('../models/User');\r\nconst jwt = require('jsonwebtoken'); //token generation\r\nconst emailValidator = require('email-validator');\r\nconst passwordValidator = require('password-validator');\r\nconst MaskData = require('maskdata');\r\n\r\nconst passwordSchema = new passwordValidator();\r\n\r\npasswordSchema\r\n    .is().min(8)  //min length\r\n    .is().max(50) //max length\r\n    .has().uppercase()  //must have...\r\n    .has().lowercase()\r\n    .has().digits()\r\n    .has().not().symbols(); // must not have...\r\n\r\n/* FONCTIONS */\r\n/* Sign-Up */\r\nexports.signup = (req, res, next) => {\r\n    if (!emailValidator.validate(req.body.email) || !passwordSchema.validate(req.body.password)) {\r\n        return res.status(400).json({message: 'Veuillez vérifier le format de votre adresse e-mail ainsi que votre mot-de-passe. Il doit comporter minimum 8 caractères et contenir des minuscules, majuscules et chiffres. Les espaces et caractères spéciaux ne sont pas autorisés.'})\r\n    } \r\n    else if (emailValidator.validate(req.body.email) || passwordSchema.validate(req.body.password)) {\r\n        const maskedMail = MaskData.maskEmail2(req.body.email);\r\n        bcrypt.hash(req.body.password, 10)\r\n        .then (hash => {\r\n            const user = new User ({\r\n                email: maskedMail,\r\n                password: hash\r\n            });\r\n            user.save()\r\n            .then(hash => res.status(201).json({message: 'Utilisateur créé!'}))\r\n            .catch(error => res.status(400).json({error}))\r\n        })\r\n        .catch(error => res.status(500).json({error}))\r\n    };\r\n}\r\n\r\n/* Log-in */\r\nexports.login = (req, res, next) => {\r\n    const maskedMail = MaskData.maskEmail2(req.body.email);\r\n    User.findOne({email: maskedMail}) // check if the email address is in the data-base\r\n    .then(user => {\r\n        if(!user) {\r\n            return res.status(401).json({error: 'Utilisateur non trouvé!'});\r\n        }\r\n        bcrypt.compare(req.body.password, user.password) //compares the hashes\r\n        .then (valid => {\r\n            if (!valid) {\r\n                return res.status(401).json({error: 'Mot de passe incorrect!'});\r\n            }\r\n            res.status(200).json({\r\n                userId: user._id,\r\n                token: jwt.sign(\r\n                    {userId: user._id},\r\n                    'RANDOM_TOKEN_SECRET',\r\n                    {expiresIn: '24h'}\r\n                )\r\n            })\r\n        })\r\n        .catch(error => res.status(500).json({error}));\r\n    })\r\n    .catch(error => res.status(500).json({error}));\r\n};"],"file":"user.dev.js"}